"use strict";!function(){var a="#js-hyfy-extension-recording-panel-v2",b="#js-hyfy-extension-recording-panel",c=".js-hide-for-extension",d="#js-hyfy-extension-attach-recording",e=".js-hyfy-extension-error",f="#js-hyfy-extension-error-login",g="#js-hyfy-extension-error-license",h="hyfy-jira-addon-controls-div",i="hyfy-jira-addon-controls-iframe",j="hyfy-extension-event",k=window.logModule.getLogger("JiraAddonRecordingContentScript"),l=null,m=null,n=function(){k.info("_init","entering"),0==$(g).length&&(BackgndAPI.isUserLoggedIn({},function(a){a.loggedIn?($(c).addClass("hide"),$(d).removeClass("hide"),v(),y()):($(e).addClass("hide"),$(f).removeClass("hide")),A()}),BackgndAPI.getCurrentTabId({},function(a){l=a.tabId,k.info("_init","got tab id",l),p()}))},o=function(){k.debug("_reset","entering"),m=null,w()},p=function(){k.debug("_attachMessageListener","entering"),chrome.runtime.onMessage.addListener(r)},q=function(){k.debug("_removeMessageListener","entering"),chrome.runtime.onMessage.removeListener(r)},r=function(a,b,c){switch(a.message){case window.constantsModule.JS_MESSAGES.DISABLE_CONTENT_SCRIPT:k.info("_messageListener","processing",a),s();break;case window.constantsModule.JS_MESSAGES.CHECK_CONTENT_SCRIPT:k.info("_messageListener","processing",a),c({status:!0});break;case window.constantsModule.JS_MESSAGES.UPDATE_USER_STATUS:k.debug("_messageListener","processing",a),t(a.statusUpdate);break;case window.constantsModule.JS_MESSAGES.UPDATE_RECORDING_STATUS:k.debug("_messageListener","processing",a),u(a.statusUpdate)}},s=function(){k.info("_destroy","entering"),q(),o()},t=function(a){a.loggedIn?($(c).addClass("hide"),$(d).removeClass("hide"),v(),y()):($(e).addClass("hide"),$(f).removeClass("hide"),$(d).addClass("hide"),$(c).removeClass("hide"),w()),A()},u=function(a){var b=a.recordingStatus;switch(a.type){case window.constantsModule.RECORDING_EVENTS.STATE_CHANGE:switch(b.state){case window.constantsModule.RECORDING_STATES.NEW:case window.constantsModule.RECORDING_STATES.STARTING:m=b.recordingId;break;case window.constantsModule.RECORDING_STATES.READY:break;case window.constantsModule.RECORDING_STATES.RUNNING_COUNTDOWN:break;case window.constantsModule.RECORDING_STATES.ACTIVE:break;case window.constantsModule.RECORDING_STATES.PROCESSING:b.recordingStartSource==window.constantsModule.RECORDING_START_SOURCE.JIRA_ADDON&&x(b);break;case window.constantsModule.RECORDING_STATES.UPLOADING:case window.constantsModule.RECORDING_STATES.COMPLETED:case window.constantsModule.RECORDING_STATES.RECORDING_FAILED:}break;case window.constantsModule.RECORDING_EVENTS.PROGRESS:break;case window.constantsModule.RECORDING_EVENTS.CLIENT_PROP_CHANGE:}},v=function(){k.info("_embedControlsIframe","entering"),w();var c=void 0,d=!1,e=void 0;if($(a).length>0)$(b).addClass("hide"),e=a,c=window.utilsModule.getLocalUrl(window.window.urlsModule.LOCAL_URLS.templates.jira_addon_recorder_iframe_v2),d=!0;else{if(!($(b).length>0))return;e=b,c=window.utilsModule.getLocalUrl(window.window.urlsModule.LOCAL_URLS.templates.jira_addon_recorder_iframe)}var f=$("<div></div>");f.attr({id:h,"class":d?"v2":""});var g=$("<iframe></iframe>");g.attr({id:i,"class":d?"v2":"",scrolling:"no"}),f.append(g),$(e).prepend(f),g.on("load",function(){A(),setTimeout(function(){BackgndAPI.associatedTabReady({tabId:l})},100)}),g.attr({src:c}),g.blur(),f.on("mouseenter",function(a){k.trace("controlsIframe-mouseenter","entering"),g.focus()}),f.on("mouseleave",function(a){k.trace("controlsIframe-mouseleave","entering"),g.blur()})},w=function(){k.info("_removeControlsIframe","entering"),$("#"+h).remove()},x=function(a){var b=function(){document.dispatchEvent(new CustomEvent(j,{detail:{type:"open-share-dialog",recordingStatus:a}}))};window.clientUtilsModule.callApi({url:window.utilsModule.makeSiteUrl(window.urlsModule.SITE_API_URLS.create_session),type:"GET",success:b,error:b},!0,void 0,!0)},y=function(){if($('meta[name="addon-user-jwt"]').length){var a=$('meta[name="addon-user-jwt"]').attr("content");a&&BackgndAPI.fetchUserData({},function(b){z(b,window.constantsModule.USER_SUBSCRIPTIONS.PRO)||a&&BackgndAPI.addJiraAddonSubscription({addonUserJwt:a})})}},z=function(a,b){var c=a.subscriptions;if(c){var d=c.userSubscriptions;for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];if(f.planId==b)return!0}}return!1},A=function(){document.dispatchEvent(new CustomEvent(j,{detail:{type:"resize-frame"}}))};$(document).ready(function(){k.info("document-ready","entering"),n()})}();